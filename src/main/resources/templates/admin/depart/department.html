<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  th:replace="~{layout/admin :: adminLayout(~{this::head}, ~{::main})}">
<head>
	<!--필요한 head 추가-->
	<script src="https://kit.fontawesome.com/8dd87b7874.js" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
	<link rel="stylesheet" href="/css/depart/department.css"/>
	<script type="text/javascript">
	//부서등록버튼 누르면 새창이 떠서 등록페이지 기능구현 
	//회사명,부서명,팀명 호버시 드래그랑 메뉴아이콘보임
	//회사명 클릭시 하위그룹(부서리스트) 토글
	$(function(){
		$(".btn_toggle_tree").click(function(){
	    	$(".depart_name").slideToggle(400);
		});
		
		//부서명 클릭시 하위그룹(팀리스트)토글(html데려오기)
		$(".btn_depart_name").click(function(){
			var teamList = $(this).siblings(".team_name");
			var depId = $(this).siblings(".department-id").val();
			$.ajax({
				url:`/admin/getTeamList/${depId}`,
				success:function(resultHtml){
					$(teamList).html(resultHtml);
					$(teamList).slideToggle(400);
					
					//팀의 메뉴아이콘 클릭시 팀메뉴리스트 토글
					//페이지를 불어왔기때문에 해당 페이지에 관한 함수는 여기서 처리
					$(".team-icon-menu").click(function(){
						var target=$(this).siblings(".team_manu");
						$(".team_manu").not(target).hide();//다른 팀의 메뉴아이콘 클릭시 닫아주기
						target.slideToggle(400);
					});
				},
				error: function(){
					alert("에러");
				}
				//1.열릴때만 가져오고 닫을때는 안가져오게 만들기
				//2.열리면서 팀리스트가 내려오게 만들기. 
			});
		});
		
		//부서의 메뉴아이콘 클릭시 부서메뉴리스트 토글
		$(".dep-icon-menu").click(function(){
			var target=$(this).siblings(".depart_menu");
			//다른 부서의 메뉴아이콘 클릭시 닫아주기
			$(".depart_menu").not(target).hide();
			target.slideToggle(400);
		});
		//부메리-팀 등록
		
		//부메리-부서 삭제 기능 
		function depDelete(el){
			var target=$(el);//클릭한 삭제버튼태그
			var dep_id = target.siblings(".department-id").val();//클릭한 삭제버튼의 부서번호
			var departmentName=target.parents("span").siblings(".dept-name").text();//클릭한 삭제버튼의 부서이름
			//alert(dep_id); 부서의 pk값이 나옴 
				if(confirm("정말 삭제하시겠습니까?")){//삭제처리시 물어보기
					$.ajax({
		           		url:"/admin/depDelete/"+dep_id, //부서번호로 경로 넘겨주기
		           		type:"delete",		//딜리트매핑이니까 타입도 딜리트
		           		success:function(result){	//성공했을경우.
		           			target.parents(".depart_name").remove(); //삭제되면 주르륵뜬거 삭제해주기 
		           			alert(departmentName+"부서가 삭제되었습니다.");
		           		}//success:function
					});//$.ajax
				}	//if
			} //function depDelete
		
		
		}); //close jquery
	
	
	
		
		
		
		//부메리-부서명 수정 
	
	
		//팀메리-팀 삭제
		//팀메리-팀명 수정
		
	</script>
</head>
<main>
	<div class="container view_size_depa">
		<!-- 부서관리 타이틀 -->
		<div class="content_head between">
			<!-- 상위 페이지 설명 요약단어  -->
			<div class="flex"> 
				<p>조직도</p>
				<p>부서관리</p>
			</div>
			<!-- title + btn_dep_reg -->
			<div class="depart-top">
				<!-- 페이지이름 -->
				<div class="title_cover flex">
					<span>부서관리</span>
				</div>
				<!-- 부서등록버튼  -->
				<div class="dep_reg">
					<button type="button" class="btn_dep_reg">부서등록</button>
				</div>
			</div><!--  class="depart-top" -->
		</div> <!--  class="content_head between" -->
		<!-- 부서관리 내용 -->
		<div class="content_depart center">
			<!-- 컨텐츠바디 -->
			<div class="contents_body">
				<!-- 조직도-커버 -->
				<div class="member_view flex">
					<!-- 조직도 -->
					<div class="organization">
						<!-- 회사명 -->
						<div class="corp_name">
							<button type="button" class="btn_toggle_tree">
								<i class="fa-solid fa-sort-down"></i>
							</button>
							<i class="fa-regular fa-building"></i>
							<span>CUAgain</span>
						</div> <!-- class="corp_name" -->
						
						<!-- 회사명 밑 박스 -->
						<div class="org_tree">
							<!-- 부서명 회사누르면 토글되서 내려오는거-->
							<ul class="depart_name" th:each= "dto : ${list}">
							
								<li class="flex">
									<p class="icon-drag"><i class="fa-regular fa-bars"></i></p>
									<button type="button" class="btn_depart_name">
										<i class="fa-solid fa-sort-down"></i>
									</button>
									<span th:text="${dto.name}" class="dept-name"></span>
									<input type="hidden" class="department-id" th:value="${dto.id}">
									<p class="dep-icon-menu"><i class="fa-regular fa-ellipsis-vertical"></i></p>
									
									<!-- 부서메뉴 -->
									<ul class="depart_menu"  th:id="|menuBtn_${dtoStat.count}|">
										<li onclick="teamInsert(this)" class="teamIn">팀 등록</li>
										<input type="hidden" class="department-id" th:value="${dto.id}">
										
										<li>
											<button type="button" th:onclick="depDelete(this)" >부서 삭제</button>
											<input type="hidden" class="department-id" th:value="${dto.id}">
										</li>
										
										<li onclick="depUpdate(this)" class="depUp">부서명 수정</a></li>
										<input type="hidden" class="department-id" th:value="${dto.id}">
										<input class="depUpdate" onkeyup="enterkey()" type="text" placeholder="부서명">
										
									</ul> <!-- class="depart_menu flex" -->
									
									<!-- 팀리스트 박스-->
									<ul class="team_name">
									</ul>
								</li><!-- class="team_list" -->
							</ul> <!--  class="depart_name" -->
						</div> <!--  class="org_tree" -->
					</div> <!--class="organization" -->
				</div> <!-- class="member_view" -->
			</div> <!-- class="contents_body" -->
		</div> <!-- class="content_depart center" -->
	</div>	<!-- class="container view_size_depa" -->
</main>
</html>