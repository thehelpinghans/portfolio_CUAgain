!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  th:replace="~{layout/admin :: adminLayout(~{this::head}, ~{::main})}">
<head>
	<!--필요한 head 추가-->
	<script src="https://kit.fontawesome.com/8dd87b7874.js" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
	<link rel="stylesheet" href="/css/depart/department.css" />
	<link rel="stylesheet" href="/js/depart/department.js" />
	<script type="text/javascript" th:inline="javascript">
	$(function(){
		$("#btn_toggle_tree").click(function(){
	    	$(".org_tree").slideToggle(400);
		});
		//부서메뉴버튼 클릭 부서메뉴
		$(".btn_depart_menu").click(function(){
			//혹시 열려있는 메뉴 모두 닫기
			var target=$(this).siblings(".depart_menu");
			$(".depart_menu").not(target).hide();
			target.slideToggle(400);
		});
		//부서명 클릭 팀토글	
		$(".dept-name").click(function(){

			var teamList = $(this).siblings(".team_name")
			var depId = $(this).siblings(".department-id").val();
			$.ajax({
				url:`/admin/getTeamList/${depId}`,
				success:function(resultHtml){
					$(teamList).html(resultHtml);
					//teamList.show();
					$(teamList).slideToggle(400);
				}//1.열릴때만 가져오고 닫을때는 안가져오게 만들기
				//2.열리면서 팀리스트가 내려오게 만들기. 
			});

		});
	}); //close jquery

	//팀 추가 클릭이벤트시
	function teamInsert(el){
		$(el).hide();//자기자신 숨기고 
		$(el).siblings(".teamInsert").show(); //작성창이 나타남
	}; //close jquery

	//팀 추가 기능구현 
	$(document).ready(function(){
		$(".teamInsert").on("keyup", function(event) {
			 if (event.which == 13) {//인풋태그에 값을 입력하고 엔터키실행시
		        target=$(this);//인풋태그
		        dept_id=target.siblings(".department-id").val();//해당부서의 pk
		        //teamName=target.text(); //팀명이 입력되는 인풋값에 텍스트
//		        alert(dept_id+"의 소속되는"+teamName+"을 추가합니다");
//		        $.ajax({//부서이름으로 넘겨서 부서엔티티의 하위그룹인 팀엔티티에 데이터를 추가하는?
//	           		url:"/admin/teamInsert/"+dept_id,
//	           		type:"post",
//	           		data: {"teamName": $(this).val().trim()},
//	           		success:function(result){
//	           			alert("성공적으로 추가되었습니다.");
//	           		}

//	            });
			 } 	
		});
	}); //close jquery

	//부서삭제기능 
	function depDelete(el){
		var target=$(el);//클릭한 삭제버튼태그
		var dep_id = target.siblings(".department-id").val();//클릭한 삭제버튼의 부서번호
		var departmentName=target.parents("td").siblings(".dept-name").text();//클릭한 삭제버튼의 부서이름
		//alert(dep_id); 부서의 pk값이 나옴 
			if(confirm("정말 삭제하시겠습니까?")){//삭제처리시 물어보기
				$.ajax({
	           		url:"/admin/depDelete/"+dep_id, //부서번호로 경로 넘겨주기
	           		type:"delete",		//딜리트매핑이니까 타입도 딜리트
	           		success:function(result){	//성공했을경우.
	           			target.parents("tr").remove(); //삭제되면 주르륵뜬거 삭제해주기 
	           			alert(departmentName+"부서가 삭제되었습니다.");
	           		}
				});
			}	
	}; //close jquery

	//부서수정 클릭이벤트시
	function depUpdate(el){
		$(el).hide(); //부서수정사라지고
		$(el).siblings(".depUpdate").show();//작성창만나타남
	}; //close jquery

	//부서수정 기능
	$(document).ready(function(){
	    $(".depUpdate").on("keyup", function(event) {
	        if (event.which == 13) {//엔터키가 실행될 경우

	        	var target=$(this);//엔터키가 실행된 태그
	        	var dept_id=target.siblings(".department-id").val();//엔터키가 실행된 태그 중에서 department-id의 클래스 이름을 가지고 있는 형제태그
	        	//alert(dept_id);//해당 부서의 pk값
	        	//*
	           	$.ajax({
	           		url:"/admin/depUpdate/"+dept_id, 
	           		type:"post",							//공백제거
	           		data: {"departmentName": $(this).val().trim()}, //입력된 값의 변수이름:입력창.변수.공백제거
	           		success:function(result){
	           			target.parents("td").siblings(".dept-name").text(result); //부모태그의 dept-name이란 td보여주기
	           			target.parents(".depart_menu").hide(); //열린 부서메뉴 숨겨주기
	           			target.val("");//부서의 pk값 리셋 
	           			target.hide();//클릭되서 열린거 다시 숨겨주기
	           		}
	            });
	        }
	    });
	}); //close jquery

	</script>	

</head>
<main>	
	<div class="container view_size_depa">
		<!-- 부서관리 타이틀 -->
		<div class="content_head">
			<div class="title_cover flex">
				<span>부서관리</span>
			</div>			
		</div>
		<div class="content_depart center">
		<!-- 부서관리 내용 -->
		<!-- 데이터 다 뿌려줘야함. -->
			<div class="contents_body">
				<div class="member_view  flex">
				<div class="depart-insert">
					<button>
						<span></span>
					</button>
				</div>
					<div class="organization">

						<section>
							<button type="button" id="btn_toggle_tree">
								<i class="fa-solid fa-sort-down"></i>&nbsp;
								<i class="fa-regular fa-building"></i>&nbsp;
								<span class="corp_name">&nbsp;&nbsp;CUAgain(회사명)</span>
							</button>
						</section>
						<section>
							<div class="org_tree">
								<ul class="tree_team">
									<li class="depart_name">
									<button type="button" class="btn_tree_team">&nbsp;&nbsp;
											<table class="dep-table">
												<tbody>
													<tr class="dep-tr2" th:each= "dto : ${list}">
														<td><i class="fa-solid fa-sort-down"></i>&nbsp;&nbsp;&nbsp;&nbsp;</td>
														<td><i class="fa-solid fa-user-group"></i>&nbsp;&nbsp;&nbsp;&nbsp;</td>
									 					<td th:text="${dto.name}" class="dept-name"></td>
									 					<input type="hidden" class="department-id" th:value="${dto.id}">
														<td>
															<div onclick="" class="btn_depart_menu" th:id="|menuBtn_${dtoStat.count}|"> 
																<i class="fa-regular fa-ellipsis-vertical"></i>
															</div>
															<div class="depart_menu flex">
																<p>
																	<a href="#" onclick="teamInsert(this)" class="teamIn">팀명 추가</a>
																	<input type="hidden" class="department-id" th:value="${dto.id}">
																	<input class="teamInsert" onkeyup="enterkey()" type="text" placeholder="팀명">
																</p>
																<p>
																	<button type="button" th:onclick="depDelete(this)" >부서 삭제</button>
																	<input type="hidden" class="department-id" th:value="${dto.id}">
																</p>
																<p>
																	<a href="#" onclick="depUpdate(this)" class="depUp">부서명 수정</a>
																	<input type="hidden" class="department-id" th:value="${dto.id}">
																	<input class="depUpdate" onkeyup="enterkey()" type="text" placeholder="부서명">
																</p>
															</div>
															<br>
														</td>
														<td class                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                ="team_name">
															<!-- 안에 있는 내용은 teamtag를 데려옴 -->
														</td>
								    				</tr>
							    			</tbody>
										</table>
									</button>
									</li>
								</ul>
							</div><!-- div class="org_tree" 회사명 누르면 나옴
							  -->

						</section>
					</div><!-- div class="organization" -->
				</div><!-- div class="member_view  flex" -->
			</div><!-- div class="contents_body" -->
		</div><!-- div class="content_depart center" -->
	</div><!-- div class="container view_size_depa" -->
</main>
</html>